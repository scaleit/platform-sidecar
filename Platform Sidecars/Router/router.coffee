$ = require 'dollar'
app = do require 'express'
http = require 'http'
basicAuth = require 'express-basic-auth'
querystring = require 'querystring'
url = require "url"

port = 1000
app_server = "sda-test-app:1003"
auth_server = "x-spsc-identity-mananger:1001"
license_server = "x-spsc-license-mananger:1002"

gandalf_image = 'data:image/jpeg;base64,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l8NQ6lqvhrU/Dl9kxz2N+qh1YAZKlSdyE9DwTjoK8q+Mnwsubj45eBfin4b0yO7urfUoLTWovKDfuM4W5wf4kGVLckDYRwpr3aigDN8S6DoniXSJtI8QaVZ6pp8337e6hWRCexwehHYjkdq4PTvgj4X0mD7HoOveNdE04ElbCw8SXUVvHk5IRd528+hFenUUAc74J8E+F/BltND4c0iGze5bfdXBJkuLluTullcl5DknlieprR8Taq2iaDeaqum6hqjW0ZcWdhEJLib/AGUUkZP41o0UAfFGu23xi1P9pS0+Mdp8JNbTT7No449PmeNZ2gERjbPPDnczAY44HPU/XfgjX5fE3h+LVZ9A1jQZHdkay1WFYp0KnGSAxGD2Oea3KKAM3xRqkmieH73VYdLvtWltoi6WVkgeec9lQEgE/jXyt+zpdfFLwH498Ual4n+EuunTvFupG8llsokkltJXkY4YFhmMCQ56EYzg5xX13RQB5/rnwZ+G+ueILnxFqnh43OsXEgla/wDttws6MBgbHVwYwOwXAFdz9ki/s/7Dum8nyvJz5rb9uMffzuzj+LOe+c1PRQB5vY/Av4U2N9FqFl4Sitr+GTzUvIbudLgP3bzRJvJPck85Oa800zxD44+CnxG8TabqngTV9Z+H+r6rNqVhf6RCbmW1eYhnUoDwmc/KQuDkjdmvpOigDwXx/wCMPEXxd8OXPgX4d+FtfsrXVl+zapr2sWLWdvaWrcS+WsmHlkK5XaB369xW+K3hzxh8Ndf8D+MPhf4Xl8Q2uh6OdB1axR/3stkhjMW1RyzZDncA2DglSM19B0UAeNQ/HuDUtNVNA+G/jy/16RcJpkukvbhJPSSZv3aLnq2T9K51PDHxH+GfwL8V+JNJRNR+JniHUV1O8WytftCxvJKoMMaHO5UQv68luoAr6HooA82/Zv1L4gar8M4bz4mW1zbeIGupQyXFssD+VkbCUUADv2r0miigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z'

globalTimeout = 15000 # ms

read = (s, cb) ->
	bufs = []
	removeListeners = () ->
		s.removeListener 'error', on_error
		s.removeListener 'data', on_data
		s.removeListener 'end', on_end
		clearTimeout timeout if timeout?
	timeout = setTimeout () ->
		timeout = null
		do removeListeners
		do s.destroy
		cb new Error 'timeout'
	, globalTimeout
	s.on 'data', on_data = (buf) -> bufs.push buf
	s.once 'end', on_end = () ->
		do removeListeners
		cb null, Buffer.concat bufs
	s.once 'error', on_error = (err) ->
		do removeListeners
		cb err

http_get = (opts, seq, cb) ->
	cb = seq if !cb?
	opts = url.parse opts if typeof opts == 'string'
	req = http.get opts
	timeout = null
	tmpErr = new Error
	removeListeners = () ->
		req.removeListener 'error', on_error
		req.removeListener 'response', on_response
		req.removeListener 'socket', on_socket
		clearTimeout timeout if timeout?
		req.on 'error', (err) -> #console.log "ignoring error on request after response: #{err.message}"
	req.once 'error', on_error = (err) ->
		do removeListeners
		tmpErr.message = err.message
		cb tmpErr
	req.once 'response', on_response = (response) ->
		do removeListeners
		#console.log response
		cb null, response
	req.once 'socket', on_socket = () ->
		timeout = setTimeout () ->
			do removeListeners
			do req.abort
			tmpErr.message = 'timeout'
			cb tmpErr
		, globalTimeout
 
auth = basicAuth
	authorizeAsync: true
	challenge: true
	realm: 'Login'
	authorizer: $ (user, password) ->
		try
			res = yield $ http_get, "http://#{auth_server}/?#{querystring.stringify {user, password}}"
			data = JSON.parse yield $ read, res
		catch err
			console.log err.stack
			return false
		return data == "ok"

app.get '/', auth, $ (req, res) ->
	app = "default"
	{user} = req.auth
	try
		res2 = yield $ http_get, "http://#{license_server}/?#{querystring.stringify {user, app}}"
		data = JSON.parse yield $ read, res2
	catch err
		console.log err.stack
		res.status(200).send 'License server error'
		return
	if data != "ok"
		gandalf_image_html = '<img alt="Embedded Image" src="'+gandalf_image+'" />'
		message = '<html><head></head><body style="text-align: center">'
		message += '<h1>ScaleIT App License Not Valid</h1>' + gandalf_image_html + '<p>Please contact <a href="mailto:scale-it.org">scale-it.org</a> for details</p>'
		message += '</body></html'
		res.status(200).send message
		return
	try
		opts = url.parse "http://#{app_server}/"
		opts.headers =
			'X-SPE-LICENSE-MANAGER--HAS-LICENSE-VECTOR': 'http://x-spe-license-manager/license-vector/34567890'
			'X-SPE-IDENTITY-MANAGER--HAS-USER-ID': 'http://x-spe-identity-manager/users/peter.pan@bmw.de'
			'X-SP-SCALEIT-PLATFORM--IS-VERIFIED': 'TRUE'
			'X-SP-SCALEIT-PLATFORM--HAS-SIGNATURE': 'vtPgjlnEyul45gdb3KfetsvBuhndyuwfiHRdsvkma9'
		res2 = yield $ http_get, opts
		data = yield $ read, res2
	catch err
		console.log err.stack
		res.status(200).send 'App server error'
		return
	res.status(200).send data.toString()
	# TODO: reverse proxy to the app server


app.listen port, () -> console.log "Listening on port #{port}!"



